<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>æ•°æ®åº“æµ‹è¯•</title>
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm'
    window.supabaseLib = { createClient }
  </script>
  <style>
    body { 
      font-family: monospace; 
      padding: 20px; 
      background: #1a1a1a; 
      color: #0f0; 
    }
    button { 
      margin: 10px 5px; 
      padding: 10px 20px; 
      background: #0f0; 
      border: none; 
      color: #000; 
      cursor: pointer; 
      font-weight: bold;
    }
    button:hover { background: #0a0; }
    pre { 
      background: #000; 
      padding: 15px; 
      border: 1px solid #0f0; 
      overflow: auto;
      max-height: 500px;
    }
    .error { color: #f00; }
    .success { color: #0f0; }
    input { 
      margin: 10px 0;
      padding: 8px;
      width: 400px;
      background: #000;
      border: 1px solid #0f0;
      color: #0f0;
      font-family: monospace;
    }
  </style>
</head>
<body>
  <h1>ğŸ“Š Supabase æ•°æ®åº“æµ‹è¯•å·¥å…·</h1>
  
  <div>
    <h3>1ï¸âƒ£ ç¯å¢ƒå˜é‡é…ç½®</h3>
    <label>SUPABASE_URL:</label><br>
    <input type="text" id="supabaseUrl" placeholder="https://xxx.supabase.co"><br>
    <label>SUPABASE_ANON_KEY:</label><br>
    <input type="text" id="supabaseKey" placeholder="eyJhbGciOiJI..."><br>
    <button onclick="initSupabase()">åˆå§‹åŒ–è¿æ¥</button>
  </div>

  <div>
    <h3>2ï¸âƒ£ æ•°æ®åº“æ“ä½œ</h3>
    <button onclick="testConnection()">æµ‹è¯•è¿æ¥</button>
    <button onclick="checkTable()">æ£€æŸ¥è¡¨ç»“æ„</button>
    <button onclick="readConfig()">è¯»å–é…ç½®</button>
    <button onclick="readLocalStorage()">è¯»å–localStorage</button>
    <button onclick="saveToDb()">ä¿å­˜localStorageåˆ°æ•°æ®åº“</button>
  </div>

  <div>
    <h3>3ï¸âƒ£ ç»“æœè¾“å‡º</h3>
    <pre id="output">ç­‰å¾…æ“ä½œ...</pre>
  </div>

  <script>
    let supabase = null;

    function log(msg, isError = false) {
      const output = document.getElementById('output');
      const className = isError ? 'error' : 'success';
      output.innerHTML += `<span class="${className}">${new Date().toLocaleTimeString()} - ${msg}</span>\n`;
      output.scrollTop = output.scrollHeight;
    }

    function initSupabase() {
      const url = document.getElementById('supabaseUrl').value;
      const key = document.getElementById('supabaseKey').value;
      
      if (!url || !key) {
        log('âŒ è¯·å¡«å†™ URL å’Œ KEY', true);
        return;
      }

      try {
        supabase = window.supabaseLib.createClient(url, key);
        log('âœ… Supabase å®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ');
      } catch (error) {
        log(`âŒ åˆå§‹åŒ–å¤±è´¥: ${error.message}`, true);
      }
    }

    async function checkTable() {
      if (!supabase) {
        log('âŒ è¯·å…ˆåˆå§‹åŒ– Supabase è¿æ¥', true);
        return;
      }

      try {
        log('ğŸ” æ£€æŸ¥ store_config è¡¨ç»“æ„...');
        
        // å°è¯•æŸ¥è¯¢è¡¨ä¿¡æ¯
        const { data, error } = await supabase
          .from('store_config')
          .select('*')
          .limit(1);
        
        if (error) {
          if (error.code === '42P01') {
            log('âŒ è¡¨ store_config ä¸å­˜åœ¨ï¼', true);
            log('éœ€è¦åœ¨ Supabase åå°æ‰§è¡Œå»ºè¡¨ SQL', true);
          } else {
            log(`âŒ æŸ¥è¯¢å¤±è´¥: ${error.message}`, true);
            log(`é”™è¯¯ä»£ç : ${error.code}`, true);
          }
        } else {
          log('âœ… è¡¨ store_config å­˜åœ¨');
          if (data && data.length > 0) {
            log('è¡¨ä¸­å­—æ®µ:');
            log(JSON.stringify(Object.keys(data[0]), null, 2));
          } else {
            log('è¡¨ä¸ºç©ºï¼Œæ— æ³•æ˜¾ç¤ºå­—æ®µç»“æ„');
          }
        }
      } catch (error) {
        log(`âŒ æ£€æŸ¥å¼‚å¸¸: ${error.message}`, true);
      }
    }

    async function testConnection() {
      if (!supabase) {
        log('âŒ è¯·å…ˆåˆå§‹åŒ– Supabase è¿æ¥', true);
        return;
      }

      try {
        log('ğŸ” æµ‹è¯•æ•°æ®åº“è¿æ¥...');
        const { data, error } = await supabase
          .from('store_config')
          .select('count')
          .single();
        
        if (error && error.code !== 'PGRST116') {
          log(`âŒ è¿æ¥å¤±è´¥: ${error.message}`, true);
        } else {
          log('âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ');
        }
      } catch (error) {
        log(`âŒ æµ‹è¯•å¤±è´¥: ${error.message}`, true);
      }
    }

    async function readConfig() {
      if (!supabase) {
        log('âŒ è¯·å…ˆåˆå§‹åŒ– Supabase è¿æ¥', true);
        return;
      }

      try {
        log('ğŸ” è¯»å–æ•°æ®åº“é…ç½®...');
        const { data, error } = await supabase
          .from('store_config')
          .select('*')
          .single();
        
        if (error && error.code !== 'PGRST116') {
          log(`âŒ è¯»å–å¤±è´¥: ${error.message}`, true);
          log(`é”™è¯¯è¯¦æƒ…: ${JSON.stringify(error, null, 2)}`, true);
        } else if (!data) {
          log('âš ï¸  æ•°æ®åº“é…ç½®ä¸ºç©º');
        } else {
          log('âœ… æ•°æ®åº“é…ç½®:');
          log(JSON.stringify(data, null, 2));
        }
      } catch (error) {
        log(`âŒ è¯»å–å¼‚å¸¸: ${error.message}`, true);
      }
    }

    function readLocalStorage() {
      log('ğŸ” è¯»å– localStorage...');
      const config = localStorage.getItem('CR_STORE_CONFIG');
      if (config) {
        log('âœ… localStorage é…ç½®:');
        log(JSON.stringify(JSON.parse(config), null, 2));
      } else {
        log('âš ï¸  localStorage æ²¡æœ‰é…ç½®æ•°æ®');
      }
    }

    async function saveToDb() {
      if (!supabase) {
        log('âŒ è¯·å…ˆåˆå§‹åŒ– Supabase è¿æ¥', true);
        return;
      }

      const configStr = localStorage.getItem('CR_STORE_CONFIG');
      if (!configStr) {
        log('âŒ localStorage æ²¡æœ‰é…ç½®æ•°æ®', true);
        return;
      }

      try {
        const config = JSON.parse(configStr);
        log('ğŸ” å‡†å¤‡ä¿å­˜åˆ°æ•°æ®åº“...');
        
        // è½¬æ¢ä¸º snake_case
        const dbConfig = {
          store_name: config.storeName,
          shop_name: config.shopName,
          logo_type: config.logoType,
          logo_image: config.logoImage,
          marquee_text: config.marqueeText,
          contact_email: config.contactEmail,
          hero_slides: config.heroSlides || [],
          sectors: config.sectors || [],
          categories: config.categories || [],
          category_tree: config.categoryTree || [],
          custom_pages: config.customPages || [],
          bundle_offers: config.bundleOffers || [],
          shipping_config: config.shippingConfig,
          paypal_config: config.paypalConfig,
          volume_discount_config: config.volumeDiscountConfig,
          brand_values: config.brandValues || [],
          social_videos: config.socialVideos || []
        };

        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
        const { data: existing } = await supabase
          .from('store_config')
          .select('id')
          .single();

        if (existing) {
          log('ğŸ“ æ›´æ–°ç°æœ‰é…ç½®...');
          const { data, error } = await supabase
            .from('store_config')
            .update({ ...dbConfig, updated_at: new Date().toISOString() })
            .eq('id', existing.id)
            .select();
          
          if (error) {
            log(`âŒ æ›´æ–°å¤±è´¥: ${error.message}`, true);
            log(`é”™è¯¯è¯¦æƒ…: ${JSON.stringify(error, null, 2)}`, true);
          } else {
            log('âœ… é…ç½®æ›´æ–°æˆåŠŸ');
            log(JSON.stringify(data, null, 2));
          }
        } else {
          log('ğŸ“ æ’å…¥æ–°é…ç½®...');
          const { data, error } = await supabase
            .from('store_config')
            .insert([dbConfig])
            .select();
          
          if (error) {
            log(`âŒ æ’å…¥å¤±è´¥: ${error.message}`, true);
            log(`é”™è¯¯è¯¦æƒ…: ${JSON.stringify(error, null, 2)}`, true);
          } else {
            log('âœ… é…ç½®æ’å…¥æˆåŠŸ');
            log(JSON.stringify(data, null, 2));
          }
        }
      } catch (error) {
        log(`âŒ ä¿å­˜å¼‚å¸¸: ${error.message}`, true);
      }
    }
  </script>
</body>
</html>
